<!DOCTYPE html>
<html lang="en-GB">

<head>
  <meta http-equiv="X-Clacks-Overhead" content="GNU Terry Pratchett" />
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="shortcut icon" href="https://blog.melkorm.dev/images/favicon2.png" />
<title>Hosting Single Page Applications on GCP | melkorm&#39;s blog</title>
<meta name="title" content="Hosting Single Page Applications on GCP" />
<meta name="description" content="With all Single Page Applications, there is a problem of hosting it without any backend
and also making sure that seo, cache and routing works correctly, which means:

all non-assets requests go to index.html,
all assets are cached but index.html,
when releasing a new page, everything is refreshed and client won&rsquo;t receive stale information,
CDN works correctly including the above,
Not found pages return the correct 404 HTTP status code.

The last point on the list is the hardest to implement correctly." />
<meta name="keywords" content="seo,google,gcp,gcs,frontend,spa,terraform," />


<meta property="og:url" content="https://blog.melkorm.dev/hosting-single-page-applications-on-gcp/">
  <meta property="og:site_name" content="melkorm&#39;s blog">
  <meta property="og:title" content="Hosting Single Page Applications on GCP">
  <meta property="og:description" content="With all Single Page Applications, there is a problem of hosting it without any backend and also making sure that seo, cache and routing works correctly, which means:
all non-assets requests go to index.html, all assets are cached but index.html, when releasing a new page, everything is refreshed and client won’t receive stale information, CDN works correctly including the above, Not found pages return the correct 404 HTTP status code. The last point on the list is the hardest to implement correctly.">
  <meta property="og:locale" content="en_GB">
  <meta property="og:type" content="article">
    <meta property="article:section" content="blog">
    <meta property="article:published_time" content="2025-11-17T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-11-17T00:00:00+00:00">
    <meta property="article:tag" content="Seo">
    <meta property="article:tag" content="Google">
    <meta property="article:tag" content="Gcp">
    <meta property="article:tag" content="Gcs">
    <meta property="article:tag" content="Frontend">
    <meta property="article:tag" content="Spa">




  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Hosting Single Page Applications on GCP">
  <meta name="twitter:description" content="With all Single Page Applications, there is a problem of hosting it without any backend and also making sure that seo, cache and routing works correctly, which means:
all non-assets requests go to index.html, all assets are cached but index.html, when releasing a new page, everything is refreshed and client won’t receive stale information, CDN works correctly including the above, Not found pages return the correct 404 HTTP status code. The last point on the list is the hardest to implement correctly.">




  <meta itemprop="name" content="Hosting Single Page Applications on GCP">
  <meta itemprop="description" content="With all Single Page Applications, there is a problem of hosting it without any backend and also making sure that seo, cache and routing works correctly, which means:
all non-assets requests go to index.html, all assets are cached but index.html, when releasing a new page, everything is refreshed and client won’t receive stale information, CDN works correctly including the above, Not found pages return the correct 404 HTTP status code. The last point on the list is the hardest to implement correctly.">
  <meta itemprop="datePublished" content="2025-11-17T00:00:00+00:00">
  <meta itemprop="dateModified" content="2025-11-17T00:00:00+00:00">
  <meta itemprop="wordCount" content="1023">
  <meta itemprop="keywords" content="Seo,Google,Gcp,Gcs,Frontend,Spa,Terraform">
<meta name="referrer" content="no-referrer-when-downgrade" />

  <style>
  :root {
    --width: 720px;
    --font-main: Verdana, sans-serif;
    --font-secondary: Verdana, sans-serif;
    --font-scale: 1em;
    --background-color: #fff;
    --heading-color: #222;
    --text-color: #444;
    --link-color: #3273dc;
    --visited-color: #8b6fcb;
    --blockquote-color: #222;
  }

  @media (prefers-color-scheme: dark) {
    :root {
      --background-color: #01242e;
      --heading-color: #eee;
      --text-color: #ddd;
      --link-color: #8cc2dd;
      --visited-color: #8b6fcb;
      --blockquote-color: #ccc;
    }
  }

  body {
    font-family: var(--font-secondary);
    font-size: var(--font-scale);
    margin: auto;
    padding: 20px;
    max-width: var(--width);
    text-align: left;
    background-color: var(--background-color);
    word-wrap: break-word;
    overflow-wrap: break-word;
    line-height: 1.5;
    color: var(--text-color);
  }

  h1,
  h2,
  h3,
  h4,
  h5,
  h6 {
    font-family: var(--font-main);
    color: var(--heading-color);
  }

  a {
    color: var(--link-color);
    cursor: pointer;
    text-decoration: none;
  }

  a:hover {
    text-decoration: underline;
  }

  nav a {
    margin-right: 8px;
  }

  strong,
  b {
    color: var(--heading-color);
  }

  button {
    margin: 0;
    cursor: pointer;
  }

  time {
    font-family: monospace;
    font-style: normal;
    font-size: 15px;
  }

  main {
    line-height: 1.6;
  }

  table {
    width: 100%;
  }

  hr {
    border: 0;
    border-top: 1px dashed;
  }

  img {
    max-width: 100%;
  }

  code {
    font-family: monospace;
    padding: 2px;
    border-radius: 3px;
  }

  blockquote {
    border-left: 1px solid #999;
    color: var(--blockquote-color);
    padding-left: 20px;
    font-style: italic;
  }

  footer {
    padding: 25px 0;
    text-align: center;
  }

  .title:hover {
    text-decoration: none;
  }

  .title h1 {
    font-size: 1.5em;
  }

  .inline {
    width: auto !important;
  }

  .highlight,
  .code {
    border-radius: 3px;
    margin-block-start: 1em;
    margin-block-end: 1em;
    overflow-x: auto;
  }

   
  ul.blog-posts {
    list-style-type: none;
    padding: unset;
  }

  ul.blog-posts li {
    display: flex;
  }

  ul.blog-posts li span {
    flex: 0 0 130px;
  }

  ul.blog-posts li a:visited {
    color: var(--visited-color);
  }

</style>
<meta
    name="google-site-verification"
    content="fGp3l5hbDnick6-4vgSqr6zaV-r0sot-ogcRdh4w-3A"
/>
</head>

<body>
  <header><a href="/" class="title">
  <h2 style="display: flex; justify-content: left; gap: 5px;">
      
<img src="/images/me-gopher.jpg" width="30" height="30">
      melkorm&#39;s blog</h2>

</a>
<nav>
<a href="/">Home</a>

<a href="/blog/">Blog</a>

<a href="/about/">About</a>

</nav>
</header>
  <main> 
<h1>Hosting Single Page Applications on GCP</h1>
<p>
    <i>
        <time datetime='2025-11-17'>
            2025-11-17
        </time>
    </i>
</p>

<content> <p>With all Single Page Applications, there is a problem of hosting it without any backend
and also making sure that seo, cache and routing works correctly, which means:</p>
<ul>
<li>all non-assets requests go to <code>index.html</code>,</li>
<li>all assets are cached but <code>index.html</code>,</li>
<li>when releasing a new page, everything is refreshed and client won&rsquo;t receive stale information,</li>
<li>CDN works correctly including the above,</li>
<li><strong>Not found</strong> pages return the correct <strong>404</strong> HTTP status code.</li>
</ul>
<p>The last point on the list is the hardest to implement correctly.</p>
<p>Now, let me show you how to do it properly with Google Cloud using Cloud Storage, Cloud Load Balancer and CDN.
We will use terraform as Infrastructure as a Code which can be easily applied or clicked-trough on GCP.</p>
<h2 id="google-storage-bucket-setup">Google storage bucket setup</h2>
<p>This post assumes that the user has already setup <code>google_compute_global_forwarding_rule</code> with http to https redirect and global IP address.</p>
<p>Let&rsquo;s configure our bucket using <code>google_storage_bucket</code> resource:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-hcl" data-lang="hcl"><span style="display:flex;"><span><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;google_storage_bucket&#34; &#34;bucket&#34;</span> {
</span></span><span style="display:flex;"><span>  project <span style="color:#f92672">=</span> <span style="color:#66d9ef">var</span>.<span style="color:#66d9ef">project</span> <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#66d9ef">your</span> <span style="color:#66d9ef">GCP</span> <span style="color:#66d9ef">project</span> <span style="color:#66d9ef">ID</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  name          <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;example-bucket-name&#34;</span> <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#66d9ef">unique</span> <span style="color:#66d9ef">across</span> <span style="color:#66d9ef">GCP</span>
</span></span><span style="display:flex;"><span>  location      <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;EU&#34;</span>
</span></span><span style="display:flex;"><span>  force_destroy <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  uniform_bucket_level_access <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This bucket serves as the origin for all traffic. The actual routing to index.html will be configured in the Load Balancer setup below. To allow users access it we need to setup <code>google_storage_bucket_iam_member</code> resource.</p>
<blockquote>
<p>Warning: all files uploaded to website&rsquo;s bucket are public!</p>
</blockquote>
<p>Setting up access policy:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-hcl" data-lang="hcl"><span style="display:flex;"><span><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;google_storage_bucket_iam_member&#34; &#34;public_rule&#34;</span> {
</span></span><span style="display:flex;"><span>  bucket <span style="color:#f92672">=</span> <span style="color:#66d9ef">google_storage_bucket</span>.<span style="color:#66d9ef">bucket</span>.<span style="color:#66d9ef">name</span>
</span></span><span style="display:flex;"><span>  role   <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;roles/storage.objectViewer&#34;</span>
</span></span><span style="display:flex;"><span>  member <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;allUsers&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This way we allow everyone to view at files in our bucket.</p>
<p>Now we need to define service for our loadbalancer to use to route traffic to the bucket. For this
we can use <code>google_compute_backend_bucket</code> resource:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-hcl" data-lang="hcl"><span style="display:flex;"><span><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;google_compute_backend_bucket&#34; &#34;bucket&#34;</span> {
</span></span><span style="display:flex;"><span>  project <span style="color:#f92672">=</span> <span style="color:#66d9ef">var</span>.<span style="color:#66d9ef">project</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;website-backend-bucket&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  description      <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Backend bucket for SPA&#34;</span>
</span></span><span style="display:flex;"><span>  bucket_name      <span style="color:#f92672">=</span> <span style="color:#66d9ef">google_storage_bucket</span>.<span style="color:#66d9ef">bucket</span>.<span style="color:#66d9ef">name</span>
</span></span><span style="display:flex;"><span>  enable_cdn       <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  compression_mode <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;AUTOMATIC&#34;</span> <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#66d9ef">enable</span> <span style="color:#66d9ef">compression</span> <span style="color:#66d9ef">over</span> <span style="color:#66d9ef">the</span> <span style="color:#66d9ef">wire</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">cdn_policy</span> {
</span></span><span style="display:flex;"><span>    default_ttl <span style="color:#f92672">=</span> <span style="color:#ae81ff">3600</span> <span style="color:#960050;background-color:#1e0010">*</span> <span style="color:#ae81ff">24</span> <span style="color:#960050;background-color:#1e0010">*</span> <span style="color:#ae81ff">30</span> <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#66d9ef">one</span> <span style="color:#66d9ef">month</span> <span style="color:#66d9ef">cache</span>
</span></span><span style="display:flex;"><span>    max_ttl     <span style="color:#f92672">=</span> <span style="color:#ae81ff">3600</span> <span style="color:#960050;background-color:#1e0010">*</span> <span style="color:#ae81ff">24</span> <span style="color:#960050;background-color:#1e0010">*</span> <span style="color:#ae81ff">30</span> <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#66d9ef">one</span> <span style="color:#66d9ef">month</span> <span style="color:#66d9ef">cache</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This <code>default_ttl</code> (one month) applies primarily to static assets that do not have their own explicit <code>Cache-Control</code> metadata set when uploaded. We will override this for <code>index.html</code> in the deployment step. This also assumes that static assets have random hash added during build.</p>
<h2 id="load-balancer-setup">Load balancer setup</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-hcl" data-lang="hcl"><span style="display:flex;"><span><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;google_compute_url_map&#34; &#34;url_map&#34;</span> {
</span></span><span style="display:flex;"><span>  project <span style="color:#f92672">=</span> <span style="color:#66d9ef">var</span>.<span style="color:#66d9ef">project</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;website-url-map&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  default_service <span style="color:#f92672">=</span> <span style="color:#66d9ef">google_compute_backend_bucket</span>.<span style="color:#66d9ef">bucket</span>.<span style="color:#66d9ef">id</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">host_rule</span> {
</span></span><span style="display:flex;"><span>    hosts        <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;example.org&#34;</span>]
</span></span><span style="display:flex;"><span>    path_matcher <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;website&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">path_matcher</span> {
</span></span><span style="display:flex;"><span>    name            <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;website&#34;</span>
</span></span><span style="display:flex;"><span>    default_service <span style="color:#f92672">=</span>  <span style="color:#66d9ef">google_compute_backend_bucket</span>.<span style="color:#66d9ef">bucket</span>.<span style="color:#66d9ef">id</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">dynamic</span> <span style="color:#e6db74">&#34;route_rules&#34;</span> {
</span></span><span style="display:flex;"><span>      for_each <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;/images&#34;, &#34;/public&#34;</span>] <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">assets</span> <span style="color:#66d9ef">paths</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">content</span> {
</span></span><span style="display:flex;"><span>        priority <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span> <span style="color:#960050;background-color:#1e0010">+</span> <span style="color:#66d9ef">route_rules</span>.<span style="color:#66d9ef">key</span>
</span></span><span style="display:flex;"><span>        service  <span style="color:#f92672">=</span> <span style="color:#66d9ef">google_compute_backend_bucket</span>.<span style="color:#66d9ef">bucket</span>.<span style="color:#66d9ef">id</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">match_rules</span> {
</span></span><span style="display:flex;"><span>          prefix_match <span style="color:#f92672">=</span> <span style="color:#66d9ef">route_rules</span>.<span style="color:#66d9ef">value</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">route_rules</span> {
</span></span><span style="display:flex;"><span>      priority <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>      service  <span style="color:#f92672">=</span> <span style="color:#66d9ef">google_compute_backend_bucket</span>.<span style="color:#66d9ef">bucket</span>.<span style="color:#66d9ef">id</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">match_rules</span> {
</span></span><span style="display:flex;"><span>        prefix_match <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/404.html&#34;</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">custom_error_response_policy</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">error_response_rule</span> {
</span></span><span style="display:flex;"><span>          match_response_codes   <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;404&#34;</span>]
</span></span><span style="display:flex;"><span>          path                   <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/index.html&#34;</span>
</span></span><span style="display:flex;"><span>          override_response_code <span style="color:#f92672">=</span> <span style="color:#ae81ff">404</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        error_service <span style="color:#f92672">=</span> <span style="color:#66d9ef">google_compute_backend_bucket</span>.<span style="color:#66d9ef">bucket</span>.<span style="color:#66d9ef">id</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">route_rules</span> {
</span></span><span style="display:flex;"><span>      priority <span style="color:#f92672">=</span> <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span>      service  <span style="color:#f92672">=</span> <span style="color:#66d9ef">google_compute_backend_bucket</span>.<span style="color:#66d9ef">bucket</span>.<span style="color:#66d9ef">id</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">match_rules</span> {
</span></span><span style="display:flex;"><span>        ignore_case         <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>        path_template_match <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/**&#34;</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">route_action</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">url_rewrite</span> {
</span></span><span style="display:flex;"><span>          path_template_rewrite <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/index.html&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>There is a lot going in this snippet, so let&rsquo;s see what is what.</p>
<p><code>route_rules</code> are evaluated from highest priority (lowest number) to lowest (higher number). This means priority <code>1</code> will be evaluated before priority <code>2</code>. We increase priority by ten to easily add other rules in between without changing all other rules priorities.</p>
<p>First rules is:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-hcl" data-lang="hcl"><span style="display:flex;"><span><span style="color:#66d9ef">dynamic</span> <span style="color:#e6db74">&#34;route_rules&#34;</span> {
</span></span><span style="display:flex;"><span>  for_each <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;/images&#34;, &#34;/public&#34;</span>] <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">assets</span> <span style="color:#66d9ef">paths</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">content</span> {
</span></span><span style="display:flex;"><span>    priority <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span> <span style="color:#960050;background-color:#1e0010">+</span> <span style="color:#66d9ef">route_rules</span>.<span style="color:#66d9ef">key</span>
</span></span><span style="display:flex;"><span>    service  <span style="color:#f92672">=</span> <span style="color:#66d9ef">google_compute_backend_bucket</span>.<span style="color:#66d9ef">bucket</span>.<span style="color:#66d9ef">id</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">match_rules</span> {
</span></span><span style="display:flex;"><span>      prefix_match <span style="color:#f92672">=</span> <span style="color:#66d9ef">route_rules</span>.<span style="color:#66d9ef">value</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The rule is dynamic to setup all the paths we have for static files. We need to make sure that assets requests go directly to storage bucket and won&rsquo;t be redirected to <code>index.html</code>. This also assumes that the website doesn&rsquo;t host any static files on root path, if it does it is also needed to be added to the list, e.g. <code>robots.txt</code> or <code>favicon</code>.</p>
<p>Next we setup our <code>404</code> rule, this is needed to have an explicit rule on our load balancer which will return <code>404</code> http code when needed and still render our SPA app.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-hcl" data-lang="hcl"><span style="display:flex;"><span><span style="color:#66d9ef">route_rules</span> {
</span></span><span style="display:flex;"><span>  priority <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>  service  <span style="color:#f92672">=</span> <span style="color:#66d9ef">google_compute_backend_bucket</span>.<span style="color:#66d9ef">bucket</span>.<span style="color:#66d9ef">id</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">match_rules</span> {
</span></span><span style="display:flex;"><span>    prefix_match <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/404.html&#34;</span> <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#66d9ef">path</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">our</span> <span style="color:#66d9ef">SPA</span> <span style="color:#66d9ef">app</span> <span style="color:#66d9ef">to</span> <span style="color:#66d9ef">render</span> <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">found</span> <span style="color:#66d9ef">page</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">custom_error_response_policy</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">error_response_rule</span> {
</span></span><span style="display:flex;"><span>      match_response_codes   <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;404&#34;</span>]
</span></span><span style="display:flex;"><span>      path                   <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/index.html&#34;</span>
</span></span><span style="display:flex;"><span>      override_response_code <span style="color:#f92672">=</span> <span style="color:#ae81ff">404</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    error_service <span style="color:#f92672">=</span> <span style="color:#66d9ef">google_compute_backend_bucket</span>.<span style="color:#66d9ef">bucket</span>.<span style="color:#66d9ef">id</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><blockquote>
<p>Important! <strong>404.html file CAN&rsquo;T exist in our bucket</strong>, otherwise bucket backend will return <strong>200 OK</strong> to our load balancer and we won&rsquo;t trigger <code>custom_error_response_policy</code> section.</p>
</blockquote>
<p>In this rule we setup <code>custom_error_response_policy</code> which will work as follows:</p>
<ul>
<li>our SPA website faced with unknown resource will hard redirect user to <code>/404.html</code> page, we are not talking about just changing <code>window.path</code> we need to forcefully redirect user, using <code>window.location.href = &quot;/404.html&quot;</code>, to new page to initiate new request on our load balancer to trigger 404 status code,</li>
<li>google load balancer will try to request this file from storage bucket, which will result in 404 not found status code,</li>
<li>then it will render <code>index.html</code>, our SPA app, and return <code>404</code> http code to the user.</li>
</ul>
<h2 id="cdn-setup">CDN setup</h2>
<p>In our bucket backend we have enabled CDN but there is still a problem. When we deploy a new version of our app nothing happens and site is still served from CDN until we purge it. The good news is that there is a solution to this problem too. We can actually set additional metadata to our GCS objects which our CDN will respect. One of this metadata fields is <code>cache control</code>. We can actually tell which objects should be cached for how long overriding default settings. In our case we only want to tell to not cache <code>index.html</code> at all. To do this when using <code>gcloud</code> cli we can do:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gcloud storage cp --cache-control<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;no-cache, no-store, max-age=0&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    ./dist/index.html <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    gs://example-bucket-name/<span style="color:#e6db74">&#34;
</span></span></span></code></pre></div><p>The full process of deployment is:</p>
<ul>
<li>deploy all static assets using <code>gcloud storage cp --recursive ./dist/assets/* gs://example-bucket-name/assets/</code></li>
<li>and then deploy <code>index.html</code>.</li>
</ul>
<p>Doing this assures that users will get a new webpage without broken css/images etc. This also assumes that our application during build adds hash to the names of all static assets.</p>
 </content>

<div style="font-size:0.8em;display:flex;gap:16px;justify-content:center;">
  <p>
    
        <strike>
          &lt;&lt; Previous Post</strike>
            
  </p>
  <p>|</p>
  <p>
    
    <a href="https://blog.melkorm.dev/404-pages-with-vue.js-and-vue-router/">Next Post >></a>
    
  </p>
</div>


<p>
    
    <a href="https://blog.melkorm.dev/tag/seo/">#seo</a>
    
    <a href="https://blog.melkorm.dev/tag/google/">#google</a>
    
    <a href="https://blog.melkorm.dev/tag/gcp/">#gcp</a>
    
    <a href="https://blog.melkorm.dev/tag/gcs/">#gcs</a>
    
    <a href="https://blog.melkorm.dev/tag/frontend/">#frontend</a>
    
    <a href="https://blog.melkorm.dev/tag/spa/">#spa</a>
    
    <a href="https://blog.melkorm.dev/tag/terraform/">#terraform</a>
    
</p>

  </main>
  <footer>Made with <a href="https://github.com/janraasch/hugo-bearblog/">Hugo ʕ•ᴥ•ʔ Bear</a>
</footer>

  
</body>

</html>
